# üöÄ H∆∞·ªõng D·∫´n T√≠ch H·ª£p Stripe Cho H·ªá Th·ªëng Th√†nh Vi√™n Tr·∫£ Ph√≠

## üìã T·ªïng Quan

H∆∞·ªõng d·∫´n n√†y s·∫Ω gi√∫p b·∫°n t√≠ch h·ª£p Stripe v√†o Laravel learning platform v·ªõi database hi·ªán t·∫°i, bao g·ªìm:
- Qu·∫£n l√Ω g√≥i ƒëƒÉng k√Ω (subscription plans)
- X·ª≠ l√Ω thanh to√°n t·ª± ƒë·ªông
- Ki·ªÉm so√°t truy c·∫≠p n·ªôi dung premium
- Theo d√µi l·ªãch s·ª≠ thanh to√°n
- Webhook handling cho ƒë·ªìng b·ªô d·ªØ li·ªáu

## üéØ Ph√¢n T√≠ch Database Hi·ªán T·∫°i

### ƒêi·ªÉm m·∫°nh c·ªßa database hi·ªán t·∫°i:
‚úÖ **C·∫•u tr√∫c t·ªët**: C√≥ h·ªá th·ªëng user, course, progress tracking, gamification  
‚úÖ **Kh·∫£ nƒÉng m·ªü r·ªông**: D·ªÖ d√†ng th√™m premium features  
‚úÖ **Quan h·ªá r√µ r√†ng**: Foreign keys v√† indexes ƒë√£ ƒë∆∞·ª£c thi·∫øt k·∫ø t·ªët  

### Nh·ªØng g√¨ c·∫ßn b·ªï sung:
üîÑ **User model**: C·∫≠p nh·∫≠t ƒë·ªÉ s·ª≠ d·ª•ng `username` l√†m primary key  
‚ûï **Subscription tables**: Th√™m b·∫£ng qu·∫£n l√Ω ƒëƒÉng k√Ω v√† thanh to√°n  
üîí **Access control**: Ki·ªÉm so√°t n·ªôi dung premium  
üìä **Analytics**: Theo d√µi usage v√† revenue  

## üõ†Ô∏è B∆∞·ªõc 1: C√†i ƒê·∫∑t Dependencies

```bash
# C√†i ƒë·∫∑t Laravel Cashier v√† Stripe
composer require laravel/cashier
composer require stripe/stripe-php

# Publish Cashier migrations (t√πy ch·ªçn)
php artisan vendor:publish --tag="cashier-migrations"
```

## ‚öôÔ∏è B∆∞·ªõc 2: C·∫•u H√¨nh Environment

Th√™m v√†o file `.env`:

```env
# Stripe Configuration
STRIPE_KEY=pk_test_your_publishable_key_here
STRIPE_SECRET=sk_test_your_secret_key_here
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret_here

# Currency Settings
CASHIER_CURRENCY=vnd
CASHIER_CURRENCY_LOCALE=vi_VN
```

## üóÑÔ∏è B∆∞·ªõc 3: Ch·∫°y Migrations

```bash
# Ch·∫°y c√°c migration ƒë√£ t·∫°o
php artisan migrate

# Seed subscription plans
php artisan db:seed --class=SubscriptionPlansSeeder
```

## üèóÔ∏è B∆∞·ªõc 4: C·∫•u H√¨nh Routes

Th√™m v√†o `routes/web.php`:

```php
use App\Http\Controllers\SubscriptionController;
use App\Http\Controllers\StripeWebhookController;

// Subscription routes (c·∫ßn auth)
Route::middleware(['auth'])->group(function () {
    Route::get('/subscription/plans', [SubscriptionController::class, 'plans'])->name('subscription.plans');
    Route::post('/subscription/checkout', [SubscriptionController::class, 'createCheckoutSession'])->name('subscription.checkout');
    Route::get('/subscription/success', [SubscriptionController::class, 'success'])->name('subscription.success');
    Route::get('/subscription/cancel', [SubscriptionController::class, 'cancel'])->name('subscription.cancel');
    Route::get('/subscription/manage', [SubscriptionController::class, 'manage'])->name('subscription.manage');
    Route::get('/subscription/portal', [SubscriptionController::class, 'portal'])->name('subscription.portal');
    Route::post('/subscription/cancel-subscription', [SubscriptionController::class, 'cancelSubscription'])->name('subscription.cancel-subscription');
    Route::post('/subscription/resume', [SubscriptionController::class, 'resumeSubscription'])->name('subscription.resume');
    Route::post('/subscription/change-plan', [SubscriptionController::class, 'changePlan'])->name('subscription.change-plan');
});

// Webhook route (kh√¥ng c·∫ßn auth)
Route::post('/stripe/webhook', [StripeWebhookController::class, 'handleWebhook'])->name('stripe.webhook');

// Premium content routes
Route::middleware(['auth', 'subscription:premium_courses'])->group(function () {
    Route::get('/premium-courses', [CourseController::class, 'premiumIndex'])->name('courses.premium');
    Route::get('/premium-games', [GameController::class, 'premiumIndex'])->name('games.premium');
});
```

## üîß B∆∞·ªõc 5: ƒêƒÉng K√Ω Middleware

Th√™m v√†o `app/Http/Kernel.php`:

```php
protected $middlewareAliases = [
    // ... existing middleware
    'subscription' => \App\Http\Middleware\CheckSubscription::class,
];
```

## üí≥ B∆∞·ªõc 6: Thi·∫øt L·∫≠p Stripe Dashboard

### 6.1 T·∫°o Products v√† Prices
1. ƒêƒÉng nh·∫≠p Stripe Dashboard
2. T·∫°o Products:
   - **G√≥i C∆° B·∫£n**: `prod_basic`
   - **G√≥i Premium**: `prod_premium`
   - **G√≥i Doanh Nghi·ªáp**: `prod_enterprise`

3. T·∫°o Prices cho m·ªói product:
   - `price_basic_monthly` ‚Üí 99,000 VND/th√°ng
   - `price_premium_monthly` ‚Üí 199,000 VND/th√°ng
   - `price_premium_yearly` ‚Üí 1,900,000 VND/nƒÉm
   - `price_enterprise_monthly` ‚Üí 499,000 VND/th√°ng

### 6.2 C·∫•u H√¨nh Webhooks
1. T·∫°o webhook endpoint: `https://yourdomain.com/stripe/webhook`
2. Ch·ªçn events:
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`
   - `customer.subscription.trial_will_end`

## üé® B∆∞·ªõc 7: T·∫°o Views (T√πy ch·ªçn - c√≥ th·ªÉ t√πy ch·ªânh)

### 7.1 Subscription Plans View

```html
<!-- resources/views/subscription/plans.blade.php -->
@extends('layouts.app')

@section('content')
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-center mb-8">Ch·ªçn G√≥i ƒêƒÉng K√Ω</h1>
    
    @if($currentSubscription)
        <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded mb-6">
            <strong>G√≥i hi·ªán t·∫°i:</strong> {{ $currentSubscription->plan->name }}
            <span class="float-right">
                <a href="{{ route('subscription.manage') }}" class="text-blue-600 hover:underline">
                    Qu·∫£n l√Ω ƒëƒÉng k√Ω
                </a>
            </span>
        </div>
    @endif
    
    <div class="grid md:grid-cols-3 gap-6 max-w-6xl mx-auto">
        @foreach($plans as $plan)
        <div class="bg-white rounded-lg shadow-lg p-6 {{ $plan->id === 'price_premium_monthly' ? 'border-2 border-blue-500' : '' }}">
            @if($plan->id === 'price_premium_monthly')
            <div class="bg-blue-500 text-white text-center py-2 px-4 rounded-t-lg -mt-6 -mx-6 mb-4">
                Ph·ªï Bi·∫øn Nh·∫•t
            </div>
            @endif
            
            <h3 class="text-xl font-bold mb-2">{{ $plan->name }}</h3>
            <p class="text-gray-600 mb-4">{{ $plan->description }}</p>
            
            <div class="text-3xl font-bold mb-4">
                {{ number_format($plan->price) }} ‚Ç´
                <span class="text-sm text-gray-500">/ {{ $plan->billing_interval === 'month' ? 'th√°ng' : 'nƒÉm' }}</span>
            </div>
            
            <ul class="mb-6 space-y-2">
                @foreach($plan->features as $feature)
                <li class="flex items-center">
                    <svg class="w-4 h-4 text-green-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    {{ $this->translateFeature($feature) }}
                </li>
                @endforeach
            </ul>
            
            @if(!$currentSubscription || $currentSubscription->plan_id !== $plan->id)
            <form action="{{ route('subscription.checkout') }}" method="POST">
                @csrf
                <input type="hidden" name="plan_id" value="{{ $plan->id }}">
                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200">
                    ƒêƒÉng K√Ω Ngay
                </button>
            </form>
            @else
            <button disabled class="w-full bg-gray-400 text-white py-2 px-4 rounded-lg">
                G√≥i Hi·ªán T·∫°i
            </button>
            @endif
        </div>
        @endforeach
    </div>
</div>
@endsection
```

## üîí B∆∞·ªõc 8: Ki·ªÉm So√°t Truy C·∫≠p Premium Content

### 8.1 Trong Controllers

```php
// CourseController.php
public function show($id)
{
    $course = VideoCourse::findOrFail($id);
    
    // Ki·ªÉm tra quy·ªÅn truy c·∫≠p
    if ($course->is_premium && !auth()->user()->canAccessCourse($id)) {
        return redirect()->route('subscription.plans')
            ->with('error', 'Kh√≥a h·ªçc n√†y y√™u c·∫ßu g√≥i ƒëƒÉng k√Ω Premium.');
    }
    
    return view('courses.show', compact('course'));
}
```

### 8.2 Trong Blade Templates

```html
@if($course->is_premium && !auth()->user()->canAccessCourse($course->id))
    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
        <strong>N·ªôi dung Premium!</strong> 
        <a href="{{ route('subscription.plans') }}" class="text-blue-600 hover:underline">
            N√¢ng c·∫•p ƒë·ªÉ truy c·∫≠p
        </a>
    </div>
@else
    <!-- Hi·ªÉn th·ªã n·ªôi dung kh√≥a h·ªçc -->
@endif
```

## üìä B∆∞·ªõc 9: Theo D√µi v√† Analytics

### 9.1 Revenue Tracking

```php
// T·ªïng doanh thu th√°ng n√†y
$monthlyRevenue = PaymentHistory::successful()
    ->thisMonth()
    ->sum('amount');

// S·ªë l∆∞·ª£ng subscriber active
$activeSubscribers = User::where('subscription_status', 'active')->count();
```

### 9.2 Usage Analytics

```php
// Track feature usage
public function downloadVideo(Request $request)
{
    $user = auth()->user();
    
    if (!$user->canUseFeature('video_downloads')) {
        return response()->json(['error' => 'Feature not available in your plan'], 403);
    }
    
    // Increment usage count
    $feature = UserPlanFeature::firstOrCreate([
        'username' => $user->username,
        'feature_name' => 'video_downloads'
    ]);
    
    if (!$feature->incrementUsage()) {
        return response()->json(['error' => 'Usage limit exceeded'], 403);
    }
    
    // Process download...
}
```

## üöÄ B∆∞·ªõc 10: Deployment Checklist

### 10.1 Stripe Configuration
- [ ] T·∫°o Stripe account production
- [ ] C·∫•u h√¨nh Products v√† Prices trong production
- [ ] Thi·∫øt l·∫≠p webhook endpoint production
- [ ] C·∫≠p nh·∫≠t environment variables production

### 10.2 Database
- [ ] Ch·∫°y migrations tr√™n production
- [ ] Seed subscription plans
- [ ] Backup database tr∆∞·ªõc khi deploy

### 10.3 Testing
- [ ] Test subscription flow v·ªõi test cards
- [ ] Verify webhook handling
- [ ] Test content access controls
- [ ] Test cancellation v√† resume

## üí° L·ª£i √çch C·ªßa Implementation N√†y

### üîß K·ªπ Thu·∫≠t:
- **Scalable**: H·ªó tr·ª£ multiple plans v√† features
- **Secure**: Webhook signature verification
- **Reliable**: Error handling v√† logging
- **Maintainable**: Clean code structure

### üíº Kinh Doanh:
- **Flexible Pricing**: Nhi·ªÅu g√≥i ph√π h·ª£p v·ªõi user kh√°c nhau
- **Feature Gating**: Ki·ªÉm so√°t t√≠nh nƒÉng theo t·ª´ng g√≥i
- **Analytics**: Theo d√µi revenue v√† usage
- **Customer Experience**: Self-service subscription management

### üéØ User Experience:
- **Seamless**: Stripe Checkout ƒë∆°n gi·∫£n
- **Transparent**: Billing portal t·ª± qu·∫£n l√Ω
- **Responsive**: Real-time status updates
- **Localized**: Giao di·ªán ti·∫øng Vi·ªát

## üîß Customization Guidelines

### Th√™m T√≠nh NƒÉng M·ªõi:
1. Th√™m feature v√†o `subscription_plans.features`
2. C·∫≠p nh·∫≠t middleware ki·ªÉm tra
3. Implement logic trong controllers
4. Update UI components

### Thay ƒê·ªïi Pricing:
1. T·∫°o Price m·ªõi trong Stripe
2. C·∫≠p nh·∫≠t seeder
3. Run migration/seeder
4. Test upgrade flow

### Localization:
- S·ª≠ d·ª•ng Laravel localization cho messages
- Customize Stripe Checkout text
- Update email templates

## üéâ K·∫øt Lu·∫≠n

Implementation n√†y cung c·∫•p:
- **Foundation v·ªØng ch·∫Øc** cho subscription system
- **Integration li·ªÅn m·∫°ch** v·ªõi database hi·ªán t·∫°i  
- **Flexibility cao** ƒë·ªÉ customize theo nhu c·∫ßu
- **Production-ready** v·ªõi error handling v√† security

B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu v·ªõi Basic plan v√† Premium plan, sau ƒë√≥ m·ªü r·ªông th√™m Enterprise features khi c·∫ßn thi·∫øt.